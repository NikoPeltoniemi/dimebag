<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DimeBag</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.1.0/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.1.0/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.6/zepto.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Roboto:700|Noto+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='css/main.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <header>
      <h1>DimeBag</h1>
      <p>Taking care of your munnies.</p>
    </header>
    <div id="dimeBag"></div>
    <script type="text/babel">

      //Configuration variables
      var config = {
        api_url: "api/",
        poll_interval: 10000
      };

      //API call function
      function apiCall(data, onSuccess, onFailure){
        $.ajax({
          url: config.api_url,
          dataType: 'json',
          type: 'POST',
          data: data,
          cache: false,
          success: function(data){
            if(typeof data.status !== 'undefined' && data.status == 'OK'){
              onSuccess(data);
            } else {
              console.error('API responded with error', data.message);
              onFailure();
            }
          },
          error: function(xhr, status, err) {
            console.error('XHR failed', status, err.toString());
            onFailure();
          }.bind(this)
        });

      };

      var BuyButton = React.createClass({
        handleClick: function(e) {
          e.preventDefault();
          this.props.onPayment(this.props.amount);
        },
        render: function() {
          return (
            <button className="button-buy" onClick={this.handleClick}>{this.props.amount}€</button>
          );

        }
      });

      //User React class
      var User = React.createClass({
        onUpdate: function(){
          console.log('onupdate');
          this.props.onUpdate();
        },
        handleCreditClick: function(e) {
          e.preventDefault();
          console.log('handleCreditClick for user '+this.props.nick+', id: '+this.props.userid);

          var amount = prompt("Enter the amount of credit you want to add", "");
          if (amount != null) {
            if (parseFloat(amount) > 0) {

              apiCall(
                {a: 'addCredit', userid: this.props.userid, amount: amount},
                function(data) {
                  //Update state
                  this.onUpdate();
                }.bind(this),
                function(){
                  //Do nothing
                }.bind(this)
              );

            } else {
              alert("Sorry, couldn't parse the value entered.");
            }

          }

        },
        handlePaymentAction: function(price){
          if(window.confirm('You are about to purchase an item for '+price+'€ from the account of '+this.props.nick)){
            apiCall(
              {a: 'doPayment', userid: this.props.userid, price: price},
              function(data) {
                //Update state
                alert('Payment OK!');
                this.onUpdate();
              }.bind(this),
              function(){
                //Do nothing
                alert('Payment was NOT accepted! Check that you have balance left.');
              }.bind(this)
            );
          }

        },
        render: function() {
          return (
            <div className="user">
              <h3>
                {this.props.nick}
              </h3>
              <div className="credit">
                {parseFloat(this.props.credit).toFixed(2)}€
              </div>
              <div className="tools">
                <button className="button-credit" onClick={this.handleCreditClick}>Add credit</button>
                <BuyButton amount="1.50" onPayment={this.handlePaymentAction}/>
                <BuyButton amount="1.00" onPayment={this.handlePaymentAction}/>
              </div>
            </div>
          );

        }
      });

      //Userlist React class
      var UserList = React.createClass({
        handleUpdate: function(){
          console.log('userlist handleUpdate');
          this.props.onUpdate();
        },
        render: function() {
          var that = this;
          var userNodes = this.props.data.map(function(user) {
            return (
              <User key={user.id} userid={user.id} nick={user.nick} credit={user.credit} onUpdate={that.handleUpdate}></User>
            );
          });
          return (
            <div className="userList">
              {userNodes}
            </div>
          );

        }
      });

      //New user form React class
      var NewUserForm = React.createClass({
        getInitialState: function() {
          return {nick: '', credit: ''};

        },
        handleNickChange: function(e) {
          this.setState({nick: e.target.value});

        },
        handleCreditChange: function(e) {
          this.setState({credit: e.target.value});

        },
        handleSubmit: function(e) {
          e.preventDefault();
          var nick = this.state.nick.trim();
          var credit = this.state.credit.trim();
          if (!credit || !nick || credit == 0) {
            return;
          }

          if(window.confirm('You are creating a new user '+nick+' with initial credit of '+credit+'€')){
            this.props.onUserSubmit({nick: nick, credit: credit});
            this.setState({nick: '', credit: ''});
          }

        },
        render: function() {
          return (
            <form className="newUserForm" onSubmit={this.handleSubmit}>
              <input type="text" value={this.state.nick} placeholder="Your nickname" onChange={this.handleNickChange}/>
              <input type="number" value={this.state.credit} placeholder="Initial credit" step="any" onChange={this.handleCreditChange}/>
              <input type="submit" value="Save" />
            </form>
          );

        }
      });

      //The React class for the app
      var DimeBag = React.createClass({
        getInitialState: function() {
          return {data: []};

        },
        loadUsersFromServer: function() {
          apiCall(
            {a: 'getUsers'},
            function(data) {
              //Update state
              this.setState({data: data.users});
            }.bind(this),
            function(){
            }.bind(this)
          );

        },
        handleUserSubmit: function(user) {
          var users = this.state.data;
          var users = this.state.data;
          user.id = Date.now();

          var newUsers = users.concat([user]);
          this.setState({data: newUsers});

          apiCall(
            {a: 'createUser', user: user},
            function(data) {
              //Update state
              this.setState({data: data.users});
            }.bind(this),
            function(){
              //Revert state
              this.setState({data: users});
            }.bind(this)
          );

        },
        componentDidMount: function() {
          this.loadUsersFromServer();
          setInterval(this.loadUsersFromServer, this.props.pollInterval);

        },
        render: function() {
          return (
            <div className="dimeBag">
              <h2>Users</h2>
              <UserList data={this.state.data} onUpdate={this.loadUsersFromServer}/>
              <h2>Add an account</h2>
              <NewUserForm onUserSubmit={this.handleUserSubmit} />
            </div>
          );

        }
      });

      //Set up React
      ReactDOM.render(
        <DimeBag pollInterval={config.poll_interval}/>,
        document.getElementById('dimeBag')
      );

    </script>
  </body>
</html>